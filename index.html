<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>My first three.js app</title>
		<style>
			body { margin: 0; }
		</style>
	</head>
	<body>
		<script src="three.js"></script>
		<script>
/*================  HELPER FUNCTIONS  ================*/

function create_flying_green_cub() {
	const geometry = new THREE.BoxGeometry();
	const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
	const cube = new THREE.Mesh(geometry, material);
	cube.position.y = 2;

	return cube;
}

function create_ground() {
	// Load a texture
	texture = new THREE.TextureLoader().load( "ground.jpg" );
	texture.wrapS = THREE.RepeatWrapping;
	texture.wrapT = THREE.RepeatWrapping;
	texture.repeat.set(10, 10);

	// Create plane
	const geometry = new THREE.PlaneGeometry( 50, 50, 1, 1 );
	const material = new THREE.MeshBasicMaterial( {color: 0xffffff, side: THREE.DoubleSide, map: texture} );
	const plane = new THREE.Mesh(geometry, material);

	// Set position
	plane.rotation.x = Math.PI / 2;
	plane.position.y = -1;

	return plane;
}

function create_onscreen_text() {
	const text = document.createElement('div');
	text.style.position = 'absolute';
	//text.style.zIndex = 1;    // if you still don't see the label, try uncommenting this
	text.style.width = 100;
	text.style.height = 100;
	//text.style.backgroundColor = "white";
	text.style.color = "white";
	text.innerHTML = "temp";
	text.style.top = 200 + 'px';
	text.style.left = 200 + 'px';
	text.id = "stats";

	document.body.appendChild(text);
}

function create_sky(scene) {
	const loader = new THREE.TextureLoader();
	scene.background = loader.load('sky.jpg');
	scene.background.wrapS = THREE.RepeatWrapping;
	scene.background.wrapT = THREE.RepeatWrapping;
	scene.background.repeat.set(0.25, 1);
	//scene.background.rotation = 0.1;
}

function create_moutains_box(scene) {
	moutain_texture = new THREE.TextureLoader().load( "mountains.png" );

	const moutain_geometry = new THREE.PlaneGeometry( 50, 10, 1, 1 );
	const moutain_material = new THREE.MeshBasicMaterial( {color: 0xffffff, side: THREE.DoubleSide, map: moutain_texture, transparent: true} );
	var moutain_plane = new THREE.Mesh( moutain_geometry, moutain_material );
	//plane2.rotation.x = 1;
	//moutain_plane.rotation.x = Math.PI / 2;
	//moutain_plane.position.y = 1;
	moutain_plane.position.z = -25;
	scene.add( moutain_plane );

	var moutain_plane2 = new THREE.Mesh( moutain_geometry, moutain_material );
	moutain_plane2.position.z = 25;
	moutain_plane2.rotation.y = Math.PI;
	scene.add( moutain_plane2 );

	var moutain_plane3 = new THREE.Mesh( moutain_geometry, moutain_material );
	moutain_plane3.position.x = 25;
	moutain_plane3.rotation.y = Math.PI / 2;
	scene.add( moutain_plane3 );

	var moutain_plane4 = new THREE.Mesh( moutain_geometry, moutain_material );
	moutain_plane4.position.x = -25;
	moutain_plane4.rotation.y = -Math.PI / 2;
	scene.add( moutain_plane4 );
}

function create_player_tank() {
	const cube_texture_loader = new THREE.CubeTextureLoader();
	//loader.setPath( 'textures/cube/pisa/' );

	var textureLoader1 = new THREE.TextureLoader();

	//let loader = new THREE.TextureLoader();
	let materialArray = [
		new THREE.MeshBasicMaterial( { map: textureLoader1.load("tank_side.jpg") } ), // droit
		new THREE.MeshBasicMaterial( { map: textureLoader1.load("tank_side.jpg") } ), // gauche
		new THREE.MeshBasicMaterial( { map: textureLoader1.load("tank_top2.jpg") } ), // top
		new THREE.MeshBasicMaterial( { map: textureLoader1.load("tank_green.jpg") } ), // bottom
		new THREE.MeshBasicMaterial( { map: textureLoader1.load("tank_back.jpg") } ), // rear
		new THREE.MeshBasicMaterial( { map: textureLoader1.load("tank_front.jpg") } ), // avant
	];

	//const tank_base_material = new THREE.MeshBasicMaterial( { color: 0xffffff, map: materialArray } );
	const tank_base_geometry = new THREE.BoxGeometry( 1, 1, 1 );
	const tank_base = new THREE.Mesh( tank_base_geometry, materialArray );

	// Scale cube
	tank_base.scale.y = 0.5;
	tank_base.scale.z = 1.4;
	tank_base.scale.x = 0.9;

	// Set position lower so it touches the ground
	tank_base.position.y = -0.75;

	// Set turret rotation
//	tank_base.turrent_rotation = tank_base.rotation.y;

	return tank_base;
}

function create_player_tank_turret() {
	const cube_texture_loader = new THREE.CubeTextureLoader();
	//loader.setPath( 'textures/cube/pisa/' );

	var textureLoader1 = new THREE.TextureLoader();

	//let loader = new THREE.TextureLoader();
	let materialArray = [
		new THREE.MeshBasicMaterial( { map: textureLoader1.load("tank_green.jpg") } ), // droit
		new THREE.MeshBasicMaterial( { map: textureLoader1.load("tank_green.jpg") } ), // gauche
		new THREE.MeshBasicMaterial( { map: textureLoader1.load("tank_top1.jpg") } ), // top
		new THREE.MeshBasicMaterial( { map: textureLoader1.load("tank_green.jpg") } ), // bottom
		new THREE.MeshBasicMaterial( { map: textureLoader1.load("tank_turret_back.jpg") } ), // rear
		new THREE.MeshBasicMaterial( { map: textureLoader1.load("tank_green.jpg") } ), // avant
	];

	//const tank_base_material = new THREE.MeshBasicMaterial( { color: 0xffffff, map: materialArray } );
	const tank_turret_geometry = new THREE.BoxGeometry( 1, 1, 1 );
	const tank_turret = new THREE.Mesh( tank_turret_geometry, materialArray );

	// Scale cube
	tank_turret.scale.y = 0.3;
	tank_turret.scale.z = 0.6;
	tank_turret.scale.x = 0.6;

	// Set position above base
	tank_turret.position.y = -0.35;
	tank_turret.position.z = 0.2;

	return tank_turret;
}

/*================  INIT RENDER  ================*/
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(90, window.innerWidth / window.innerHeight, 0.1, 1000);
//camera.position.z = 5;
camera.position.y = 0.4;

const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

/*================  INIT GAME WORLD  ================*/

const world = new Object();

// Add flying cube
world.cube = create_flying_green_cub();
scene.add(world.cube);

// Add terrain
world.ground = create_ground();
scene.add(world.ground);

// Add on screen text
create_onscreen_text();

// Add sky to scene
create_sky(scene);

// Add moutains around the box
create_moutains_box(scene);

// Add the player's tank
// base
world.tank_base = create_player_tank();
scene.add(world.tank_base);
// turret
world.tank_turret = create_player_tank_turret();
scene.add(world.tank_turret);


/*================  INIT KEYBOARD  ================*/

// based on https://stackoverflow.com/a/12444641
// find out the key codes: https://keycode.info/

var map = {}; // You could also use an array
onkeydown = onkeyup = function(e) {
	e = e || event; // to deal with IE
	map[e.keyCode] = e.type == 'keydown';

	// left arrow
	if (map[37]) {
		// turn left
		world.tank_base.rotation.y += 0.1;
		world.tank_turret.rotation.y += 0.1;
	}

	// right arrow
	if (map[39]) {
		// turn right
		world.tank_base.rotation.y -= 0.1;
		world.tank_turret.rotation.y -= 0.1;
	}

	// up arrow
	if (map[38]) {
		// move forward
		world.tank_base.position.x -= 0.2 * Math.sin(world.tank_base.rotation.y);
		world.tank_base.position.z -= 0.2 * Math.cos(world.tank_base.rotation.y);
//		world.tank_turret.position.x -= 0.2 * Math.sin(world.tank_base.rotation.y);
//		world.tank_turret.position.z -= 0.2 * Math.cos(world.tank_base.rotation.y);
	}

	// down arrow
	if (map[40]) {
		// move backwards
		world.tank_base.position.x += 0.2 * Math.sin(world.tank_base.rotation.y);
		world.tank_base.position.z += 0.2 * Math.cos(world.tank_base.rotation.y);
//		world.tank_turret.position.x += 0.2 * Math.sin(world.tank_base.rotation.y);
//		world.tank_turret.position.z += 0.2 * Math.cos(world.tank_base.rotation.y);
	}

	// comma
	if (map[188]) {
		// turn turret left
		world.tank_turret.rotation.y += 0.1;
	}

	// period
	if (map[190]) {
		// turn turret right
		world.tank_turret.rotation.y -= 0.1;
	}

	// page up
	if (map[33]) {
		// move camera up
		camera.position.y += 1;
	}

	// page up
	if (map[34]) {
		// move camera down
		camera.position.y -= 1;
	}

	// Update turrent position on tank base
	world.tank_turret.position.x = world.tank_base.position.x + 0.2 * Math.sin(world.tank_base.rotation.y);
	world.tank_turret.position.z = world.tank_base.position.z + 0.2 * Math.cos(world.tank_base.rotation.y);

	// For camera to film tank from the rear
	camera.position.x = world.tank_base.position.x + 2.5 * Math.sin(world.tank_turret.rotation.y);
	camera.position.z = world.tank_base.position.z + 2.5 * Math.cos(world.tank_turret.rotation.y);
	//camera.position.y = world.tank_base.position.y;

//	camera.rotation.x = world.tank_base.rotation.x;
//	camera.rotation.z = world.tank_base.rotation.z;
	const xdiff = camera.position.x - world.tank_turret.position.x;
	const zdiff = camera.position.z - world.tank_turret.position.z;
	//camera.rotation.x = Math.atan2(ydiff, xdiff); //world.tank_base.rotation.x;
	//camera.rotation.z = Math.atan2(ydiff, xdiff); //world.tank_base.rotation.z;
	camera.rotation.y = Math.atan2(xdiff, zdiff);
}



/*================  INIT ANIMATION  ================*/

const animate = function () {
	requestAnimationFrame(animate);

	world.cube.rotation.x += 0.01;
	world.cube.rotation.y += 0.01;

	renderer.render(scene, camera);

	stats.innerHTML = "Camera: </br>    PosX: " + camera.position.x + 
	                          "</br>    PosY: " + camera.position.y +
	                          "</br>    PosZ: " + camera.position.z + 
	                          "</br>    RotX: " + camera.rotation.x +
	                          "</br>    RotY: " + camera.rotation.y +
	                          "</br>    RotZ: " + camera.rotation.z;

	// scroll background left and right
	scene.background.offset = new THREE.Vector2(-camera.rotation.y / (Math.PI * 2), 0.6);
};

animate();


		</script>
	</body>
</html>
